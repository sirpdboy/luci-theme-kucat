#!/bin/sh

#   luci-theme-kucat
#   Copyright (C) 2019-2025 The Sirpdboy Team <herboy2008@gmail.com> 
# 
#   Have a bug? Please create an issue here on GitHub!
#       https://github.com/sirpdboy/luci-theme-kucat/issues
# 
# Licensed to the public under the Apache License 2.0

# author github@sirpdboy

kucat='kucat'
[ -s "/etc/config/advancedplus" ] &&kucat='advancedplus'
dayword="$(uci -q get $kucat.@basic[0].dayword || echo '0')"

# 获取可用的WAN接口
get_available_wan_interfaces() {
	# 获取所有活跃的网络接口
	for iface in $(ip route | grep default | awk '{print $5}' | sort -u); do
		if [ -n "$iface" ] && ip link show "$iface" 2>/dev/null | grep -q "state UP"; then
			echo "$iface"
		fi
	done
}

# 检查HTTP工具可用性
check_http_tool() {
	if command -v curl >/dev/null 2>&1; then
		# 测试curl是否正常工作
		if curl --version >/dev/null 2>&1; then
			echo "curl"
			return 0
		fi
	fi
	
	if command -v wget >/dev/null 2>&1; then
		echo "wget"
		return 0
	fi
	
	return 1
}

# 使用可用工具进行HTTP请求
http_request() {
	local url="$1"
	local tool=$(check_http_tool)
	local interfaces=$(get_available_wan_interfaces)
	
	case "$tool" in
		"curl")
			# 使用curl
			if [ -z "$interfaces" ]; then
				curl -s --connect-timeout 5 --max-time 15 "$url" 2>/dev/null
			else
				for iface in $interfaces; do
					local result=$(curl --interface "$iface" -s --connect-timeout 5 --max-time 15 "$url" 2>/dev/null)
					if [ $? -eq 0 ] && [ -n "$result" ]; then
						echo "$result"
						return 0
					fi
				done
			fi
			;;
		"wget")
			# 使用wget (不支持接口绑定，但可以设置超时)
			wget -q -T 15 -t 2 -O - "$url" 2>/dev/null
			;;
		*)
			return 1
			;;
	esac
}

# 测试URL可达性
test_url() {
	local url=$1
	local tool=$(check_http_tool)
	
	case "$tool" in
		"curl")
			local interfaces=$(get_available_wan_interfaces)
			if [ -z "$interfaces" ]; then
				local status=$(curl -I -o /dev/null -skL --connect-timeout 3 --max-time 10 -w %{http_code} "$url" 2>/dev/null)
				case "$status" in
					204|200) echo '1' ;;
				esac
			else
				for iface in $interfaces; do
					local status=$(curl --interface "$iface" -I -o /dev/null -skL --connect-timeout 3 --max-time 10 -w %{http_code} "$url" 2>/dev/null)
					case "$status" in
						204|200)
							echo '1'
							return
						;;
					esac
				done
			fi
			;;
		"wget")
			# wget测试连通性
			if wget -q -T 5 -t 1 --spider "$url" 2>/dev/null; then
				echo '1'
			fi
			;;
	esac
}

get_word() {
	local checknet=$(test_url "https://www.baidu.com")
	if [ "x$checknet" == "x1" ]; then
		local result=$(http_request "https://v1.hitokoto.cn")
		if [ -n "$result" ]; then
			local hitokoto=$(echo "$result" | jsonfilter -qe '@.hitokoto')
			local from=$(echo "$result" | jsonfilter -qe '@.from')
			local from_who=$(echo "$result" | jsonfilter -qe '@.from_who')
			
			if [ -n "$hitokoto" ]; then
				if [ -n "$from" ] && [ -n "$from_who" ]; then
					echo "$hitokoto —— $from_who《$from》"
				elif [ -n "$from" ]; then
					echo "$hitokoto —— 《$from》"
				elif [ -n "$from_who" ]; then
					echo "$hitokoto —— $from_who"
				else
					echo "$hitokoto"
				fi
				return
			fi
		fi
		
		# 备用API
		local result2=$(http_request "https://api.oick.cn/yiyan/api.php")
		if [ -n "$result2" ]; then
			echo "$result2"
			return
		fi
	else
		# 备用检测：ping多个DNS服务器
		local ping_success=0
		for dns in "223.5.5.5" "8.8.8.8" "114.114.114.114"; do
			if ping -c 1 -W 2 "$dns" >/dev/null 2>&1; then
				ping_success=1
				break
			fi
		done
		
		if [ $ping_success -eq 1 ]; then
			# 网络可达但HTTP可能有问题，尝试请求
			local result=$(http_request "https://v1.hitokoto.cn")
			if [ -n "$result" ]; then
				local hitokoto=$(echo "$result" | jsonfilter -qe '@.hitokoto')
				if [ -n "$hitokoto" ]; then
					echo "$hitokoto"
					return
				fi
			fi
		fi
	fi
	
	# 所有方法都失败，返回错误信息
	echo "Acquisition failed ,Please Issues:github@sirpdboy"
}

get_word
